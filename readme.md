# portfolio_calculator.py

## 概要
このスクリプトは、指定されたCSVファイル（銘柄と保有株数）を読み込み、Yahoo Financeから現在の株価や財務指標を取得して、ポートフォリオの評価額や構成比率を計算するツールです。

## 機能
1. **株価・為替取得**: `yfinance`を使用して最新の株価とUSD/JPY為替レートを取得します。
   - 日本株（`.T`）の場合は、Yahoo!ファイナンス（日本）から日本語の企業名を取得します。
2. **指標計算**:
   - **PER (株価収益率)**: `trailingPE`を取得します。
   - **ボラティリティ (σ)**: 過去1年間の日次リターンから年率換算の標準偏差を計算します（252営業日換算）。
   - **シャープレシオ**: リスクフリーレートを4%と仮定して計算します。
3. **ポートフォリオ分析**:
   - 各銘柄の評価額（ドル建て・円建て）を計算します。
   - ポートフォリオ全体に対する各銘柄の構成比率を計算します。
   - 構成比率の降順でソートします。
4. **結果保存**: 計算結果をタイムスタンプ付きのCSVファイルとして保存します。
5. **キャッシュ機能**: APIリクエストの負荷を軽減するため、データをキャッシュします。
   - **メタデータ（社名、セクター、業種、国）**: 1週間キャッシュ
   - **ボラティリティ・シャープレシオ**: 24時間キャッシュ
   - **株価**: 15分間キャッシュ
   - キャッシュは `data/ticker_cache.json` に保存されます。

## 必要要件
以下のPythonライブラリが必要です。
- pandas
- yfinance
- numpy
- scipy (効率的フロンティア計算用)
- requests
- beautifulsoup4
- streamlit (Web UI用)
- plotly (Web UI用)

## 使い方

```bash
python portfolio_calculator.py [csv_file] [--force-refresh]
```

引数を省略した場合、デフォルトで `portfolio.csv` を読み込みます。
`portfolio_jp.csv` などの別ファイルを指定することも可能です。

### オプション
- `--force-refresh` または `-f`: キャッシュを無視してすべてのデータをAPIから再取得します。

### 例
```bash
# 通常実行（キャッシュを使用）
python portfolio_calculator.py

# キャッシュを無視して完全更新
python portfolio_calculator.py --force-refresh

# 日本株ポートフォリオを更新
python portfolio_calculator.py portfolio_jp.csv
```

## 入力ファイル形式 (CSV)
以下のカラムを持つCSVファイルを用意してください。

| ticker | shares |
|--------|--------|
| AAPL   | 10     |
| 7203.T | 100    |

※日本株の場合はティッカーに `.T` を付けてください（例: トヨタ自動車 → `7203.T`）。
スクリプトは自動的に通貨（USD/JPY）を判別して計算します。

## 出力
実行すると、コンソールに結果が表示されるほか、以下の形式でファイルが保存されます。
- 保存先: `output/` ディレクトリ
- ファイル名: `[元のファイル名]_result_YYYYMMDD_HHMMSS.csv`
- 追加されるカラム: `name`, `sector`, `price`, `PER`, `sigma`, `sharpe`, `value`, `value_jp`, `ratio`, `usd_jpy_rate`
- **備考**: `value_jp`（円建て評価額）は整数に丸められます。
- **相関行列**: `[元のファイル名]_corr_YYYYMMDD_HHMMSS.csv` として別途保存されます。

## Web UI (Streamlit)
計算結果をブラウザで可視化することができます。

### 起動方法
```bash
streamlit run portfolio_app.py
```

### 機能
- **統合ビュー (Combined View)**: デフォルトで `portfolio.csv` (米国株) と `portfolio_jp.csv` (日本株) の最新結果を自動的に結合し、一つのポートフォリオとして表示します。
- **データ更新機能**: サイドバーの「Update Data」ボタンを押すと、`portfolio.csv` および `portfolio_jp.csv` の最新情報を取得して再計算を行い、表示を更新します。
  - **キャッシュ機能**: 通常の更新ではキャッシュを活用し、APIリクエスト数を削減します。
  - **完全更新オプション**: 「Force full refresh」チェックボックスをオンにすると、キャッシュを無視してすべてのデータを再取得します。
- **履歴閲覧 (US/JP History)**: サイドバーで「US History」または「JP History」を選択すると、それぞれの過去の履歴ファイルを個別に選択して閲覧できます。
- **高度な分析**:
  - **セクター分析**: 業種別の資産配分を円グラフで表示します。
  - **リスク・リターン分析**: ボラティリティ（リスク）とシャープレシオ（効率性）の散布図を表示し、銘柄の特性を比較できます。
  - **相関行列**: 銘柄間の株価連動性をヒートマップで表示し、分散投資の効果を確認できます（個別ファイル閲覧時）。
- ポートフォリオの構成比率（円グラフ）やシャープレシオ（棒グラフ）を表示します。

### 効率的フロンティア (Modern Portfolio Theory)
現代ポートフォリオ理論（MPT）に基づく効率的フロンティアを表示し、最適なポートフォリオ配分を提案します。

#### 機能
- **効率的フロンティアの可視化**: ポートフォリオのリスク（ボラティリティ）とリターンの関係をグラフで表示します。
  - ランダムに生成されたポートフォリオの分布
  - 効率的フロンティア曲線（赤線）
  - 各銘柄の個別リスク・リターン位置
  
- **最適ポートフォリオの提案**:
  - **最大シャープレシオ・ポートフォリオ**: リスク調整済みリターンが最も高い配分
  - **最小ボラティリティ・ポートフォリオ**: リスクが最も低い配分
  - **均等加重ポートフォリオ**: すべての資産に均等に配分
  - **現在のポートフォリオ**: 現在の保有状況に基づく配分

- **リバランス推奨**: 現在のポートフォリオから最適ポートフォリオへ移行するための具体的な売買金額を提案します。

#### 使い方
1. 「Update Data」ボタンでデータを更新（価格履歴データが必要）
2. 「Efficient Frontier」セクションで各種ポートフォリオ提案を確認
3. 「Required Trades」で最適配分への具体的な売買金額を確認

#### 技術的詳細
- 過去1年間の価格データから期待リターンと共分散行列を計算
- `scipy.optimize.minimize` を使用した平均分散最適化
- リスクフリーレート: 4%（年率）

