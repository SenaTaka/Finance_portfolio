# アーキテクチャドキュメント

## 概要

このドキュメントでは、Finance Portfolio Management Systemのモジュール構造について説明します。このシステムは、拡張性と保守性を向上させ、大規模開発をサポートするためにリファクタリングされました。

## アーキテクチャの原則

1. **関心の分離**：各モジュールは単一の明確に定義された責任を持つ
2. **モジュール性**：コンポーネントは疎結合で高凝集
3. **拡張性**：既存コードを変更せずに新機能を追加しやすい
4. **テスト可能性**：コンポーネントを個別にテスト可能
5. **保守性**：明確な構造によりコードの理解と変更が容易

## ディレクトリ構造

```
Finance_portfolio/
├── src/                          # メインソースコード
│   ├── __init__.py
│   ├── core/                     # コアビジネスロジック
│   │   ├── __init__.py
│   │   └── portfolio_calculator.py
│   ├── data/                     # データアクセス層
│   │   ├── __init__.py
│   │   ├── cache_manager.py
│   │   └── stock_data_fetcher.py
│   ├── analysis/                 # 分析モジュール
│   │   ├── __init__.py
│   │   ├── efficient_frontier.py
│   │   ├── sharpe_optimized.py
│   │   └── crash_scenario_analysis.py
│   ├── ui/                       # ユーザーインターフェースコンポーネント
│   │   ├── __init__.py
│   │   ├── chart_utils.py
│   │   └── data_loader.py
│   └── utils/                    # ユーティリティモジュール
│       ├── __init__.py
│       ├── config.py
│       ├── file_utils.py
│       └── region_classifier.py
├── tests/                        # テストファイル
├── data/                         # データディレクトリ（キャッシュなど）
├── output/                       # 出力ディレクトリ（結果）
├── portfolio.csv                 # 米国ポートフォリオ入力
├── portfolio_jp.csv              # 日本ポートフォリオ入力
├── portfolio_app.py              # Streamlit UI（レガシー、今後リファクタリング予定）
└── portfolio_calculator.py       # レガシーエントリーポイント
```

## モジュール説明

### コア層（`src/core/`）

**目的**：ポートフォリオ計算のコアビジネスロジックを含む。

- `portfolio_calculator.py`：メインポートフォリオ計算エンジン
  - データ取得、計算、結果保存を統括
  - データ層を使用して取得とキャッシングを行う
  - ポートフォリオの評価と指標を生成

### データアクセス層（`src/data/`）

**目的**：すべての外部データアクセスとキャッシングを処理。

- `cache_manager.py`：株式データのキャッシング管理
  - TTLベースのキャッシュ有効期限
  - メタデータ、ボラティリティ、価格データで個別のTTL
  - JSONファイルベースのストレージ
  
- `stock_data_fetcher.py`：外部ソースから株式データを取得
  - Yahoo Finance統合
  - 為替レート取得
  - 株式メタデータ、価格、履歴データ
  - ボラティリティとシャープレシオの計算

### 分析層（`src/analysis/`）

**目的**：ポートフォリオ最適化のための分析機能を提供。

- `efficient_frontier.py`：モダンポートフォリオ理論の計算
  - 効率的フロンティア計算
  - ポートフォリオ最適化（最大シャープ、最小ボラティリティ）
  - ランダムポートフォリオ生成
  - バックテスティング機能
  
- `sharpe_optimized.py`：シャープレシオベースの最適化
  - シャープとボラティリティに基づくスコア計算
  - 目標ウェイト計算
  - 取引計画生成
  
- `crash_scenario_analysis.py`：ストレステストとシナリオ分析
  - ポートフォリオのクラッシュシナリオモデリング
  - ベータベースのインパクト分析
  - リスク軽減提案

### UI層（`src/ui/`）

**目的**：ユーザーインターフェースコンポーネントとユーティリティ。

- `chart_utils.py`：再利用可能なチャート作成ユーティリティ
  - モバイルフレンドリーなチャートレイアウト
  - 標準チャートタイプ（円グラフ、棒グラフ、散布図、線グラフ、ヒートマップ）
  - 一貫したスタイリング
  
- `data_loader.py`：UI用データロードユーティリティ
  - 統合ポートフォリオロード
  - ファイル選択とロード
  - 相関マトリックスロード

### ユーティリティ層（`src/utils/`）

**目的**：共通ユーティリティと設定。

- `config.py`：中央設定管理
  - ディレクトリパス
  - キャッシュ設定
  - デフォルト値
  - UI設定
  
- `file_utils.py`：ファイル操作ユーティリティ
  - ファイル名からのタイムスタンプ抽出
  - ファイルパターンマッチング
  - ディレクトリ管理
  
- `region_classifier.py`：地理的分類
  - 国から地域へのマッピング
  - 地域定義

## 使用されているデザインパターン

### 1. 関心の分離
各層は明確な責任を持っています：
- データ層：外部データアクセス
- コア層：ビジネスロジック
- 分析層：計算とアルゴリズム
- UI層：ユーザーインターフェース
- ユーティリティ層：共通機能

### 2. 依存性注入
コンポーネントはコンストラクタインジェクションを通じて依存関係を受け取り、テストと変更が容易になります。

### 3. 設定管理
`config.py`での集中設定により、コードを変更せずに動作を変更しやすくなります。

### 4. ストラテジーパターン
異なる分析戦略（効率的フロンティア、シャープ最適化、シナリオ分析）は別々のモジュールとして実装されています。

## 拡張性

### 新しい分析モジュールの追加

1. `src/analysis/`に新しいファイルを作成
2. 分析関数を実装
3. `src/analysis/__init__.py`にエクスポートを追加
4. UIや他のコンポーネントでインポートして使用

例：
```python
# src/analysis/my_new_analysis.py
def analyze_something(data):
    # 分析ロジック
    pass
```

### 新しいデータソースの追加

1. `src/data/`に新しいフェッチャークラスを作成
2. `StockDataFetcher`のインターフェースパターンに従う
3. `src/data/__init__.py`に追加

### 新しいUIコンポーネントの追加

1. `src/ui/chart_utils.py`に新しいチャートタイプを作成
2. 既存ユーティリティを使用して新しいページやセクションを作成
3. モバイルフレンドリーなデザインパターンに従う

## 移行ガイド

### 既存コード向け

旧モジュールは後方互換性のために残されています：
- `portfolio_calculator.py`（レガシーエントリーポイント）
- `efficient_frontier.py`（ルート）
- `sharpe_optimized.py`（ルート）

新しいコードでは以下を使用してください：
```python
from src.core.portfolio_calculator import PortfolioCalculator
from src.analysis import efficient_frontier, sharpe_optimized
from src.ui import chart_utils, DataLoader
```

### 後方互換性

新しいエントリーポイント`portfolio_calculator_new.py`は、同じCLIインターフェースを維持しながら新しいアーキテクチャを示します：

```bash
# 旧方式（まだ動作します）
python portfolio_calculator.py portfolio.csv

# 新方式（推奨）
python portfolio_calculator_new.py portfolio.csv
```

## テスト戦略

### ユニットテスト
各モジュールは`tests/`に対応するユニットテストを持つべきです：
- モジュールを個別にテスト
- 外部依存関係をモック化
- ビジネスロジックに焦点

### 統合テスト
モジュール間の相互作用をテスト：
- データ取得とキャッシング
- ポートフォリオ計算パイプライン
- UIデータロード

### エンドツーエンドテスト
完全なワークフローをテスト：
- ポートフォリオの更新と計算
- UIレンダリングと相互作用

## パフォーマンスの考慮事項

1. **キャッシング**：TTLベースのキャッシングでAPI呼び出しを削減
2. **レイジーロード**：必要な時にのみデータを取得
3. **バッチ操作**：複数の株式を効率的に処理
4. **相関マトリックス**：一度計算してキャッシュ

## 今後の機能強化

### フェーズ1：UI完全リファクタリング
- `portfolio_app.py`をモジュール化されたページに分割
- 再利用可能なUIコンポーネントを作成
- 状態管理の改善

### フェーズ2：データベース統合
- JSONキャッシュをデータベースに置き換え
- 履歴追跡を追加
- 複数ポートフォリオをサポート

### フェーズ3：リアルタイム更新
- WebSocket統合
- ライブ価格更新
- リアルタイム通知

### フェーズ4：高度な分析
- 機械学習予測
- センチメント分析
- ニュース統合

### フェーズ5：APIレイヤー
- プログラマティックアクセスのためのREST API
- 認証と認可
- レート制限

## 貢献

新機能を追加する際は：

1. モジュール構造に従う
2. 適切なドキュメントを追加
3. ユニットテストを記述
4. このアーキテクチャドキュメントを更新
5. 可能な限り後方互換性を維持

## 質問とサポート

アーキテクチャに関する質問がある場合：
1. このドキュメントを確認
2. モジュールのdocstringを確認
3. 既存のコードパターンを調査
4. インラインコメントを参照
